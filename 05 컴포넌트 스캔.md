# 컴포넌트 스캔   
지금까지 우리는 `@Bean`어노테이션을 활용하거나        
XML 설정 파일을 이용하여 스프링 컨테이너에 직접 빈을 등록했다.          
하지만, 등록하는 빈의 갯수가 많아질수록 이 또한 번거롭고 귀찮은 작업이 된다.  
무엇보다 해당 파일을 일일히 관리해주어야 하는 불편함이 있다.    

이를 해소해주기 위해, 스프링에서는 `@ComponentScan`이라는 기능을 제공한다.     
또 의존관계도 자동으로 주입해주는 `@Autowired`라는 기능도 제공해준다.      

우선, 우리는 개발자이므로 코드로 직접 기능을 알아보자  
   
**AutoAppConfig**   
```java
package hello.core;

import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.FilterType;

// 컴포넌트 스캔은 별다른 루트 디렉터리를 주지 않으면 현 클래스를 루트디렉토리로 잡는다.
// 즉, 현 클래스부터 하위 디렉터리의 @Component 어노테이션이 붙은 클래스를 빈으로 등록한다.(이 클래스도)
// 제외할 요소들을 선택하는데, AppConfig 와 같은 @Configuration 을 사용하는 클래스는 제외
@Configuration
@ComponentScan(
        excludeFilters = @ComponentScan.Filter(type = FilterType.ANNOTATION, classes = Configuration.class)
)
public class AutoAppConfig {
}
```   
이전, `AppConfig`와 비슷한 역할을 하는 `AutoAppConfig`클래스를 생성했다.         
특이한점은, `@ComponentScan`어노테이션이 붙었고 `@Bean`을 등록한 메소드가 없다.         
**그렇다면 어떻게 동작을 하는 것인가? 🤔**     
           
우리는 어노테이션의 이름 그대로에서 그 해답을 찾을 수 있다.        
`@ComponentScan` 어노테이션은 `@Component`어노테이션이 붙은 클래스를 찾는다.        
그리고 찾은 클래스들을 빈으로 자동 등록해주는 역할을 하고 있다.       
그렇기에 따로 `@Bean`어노테이션을 붙어서 빈을 등록할 필요가 없기에 이를 제거한 것이다.       
      
한 가지 특이점으로는 `@ComponentScan`에 속성값에 필터 기능을 추가했다.       
`excludeFilters`은 제외할 클래스를 지정하는데 사용하는 어노테이션 속성이다.     
이전, 우리가 사용했던 `AppConfig`에서도 우리가 등록한 빈들이 있기에      
`@ComponentScan`으로 등록할 빈 들과 충돌이 일어나기에 `@Configuration`이 붙은 클래스는 제외한 것이다.     
  
참고로, 컴포넌트 스캔을 사용하면 `@Configuration` 이 붙은 설정 정보도 자동으로 등록된다.      
`@Configuration` 이 컴포넌트 스캔의 대상이 된 이유도       
`@Configuration`의 소스코드를 열어보면 `@Component` 어노테이션이 붙어있기 때문이다.    
    
그러면 이제 빈으로 등록할 클래스들에 `@Component`어노테이션을 붙이러 가보자     
     
**RateDiscountPolicy.class**
```java
package hello.core.discount;

import hello.core.member.Grade;
import hello.core.member.Member;
import org.springframework.stereotype.Component;

@Component
public class RateDiscountPolicy implements DiscountPolicy{

    private int discountPercent = 10;

    @Override
    public int discount(Member member, int price) {
        if(member.getGrade() == Grade.VIP){
            return price * discountPercent / 100;
        }
        return 0;
    }
}
```

**MemoryMemberRepository.class**
```java
package hello.core.member;

import org.springframework.stereotype.Component;

import java.util.HashMap;
import java.util.Map;

@Component
public class MemoryMemberRepository implements MemberRepository {

    private static Map<Long, Member> store = new HashMap<>();

    @Override
    public void save(Member member) {
        store.put(member.getId(), member);
    }

    @Override
    public Member findById(Long memberId) {
        return store.get(memberId);
    }

}
```

**MemberServiceImpl.class**
```java
package hello.core.member;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

@Component
public class MemberServiceImpl implements MemberService {

    private final MemberRepository memberRepository;

    @Autowired
    public MemberServiceImpl(MemberRepository memberRepository) {
        this.memberRepository = memberRepository;
    }

    @Override
    public void join(Member member) {
        memberRepository.save(member);
    }

    @Override
    public Member findMember(Long memberId) {
        return memberRepository.findById(memberId);
    }

    // 테스트용 메서드
    public MemberRepository getMemberRepository() {
        return memberRepository;
    }

}
```
   
**OrderServiceImpl.class**
```java
package hello.core.order;

import hello.core.discount.DiscountPolicy;
import hello.core.member.Member;
import hello.core.member.MemberRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

@Component
public class OrderServiceImpl implements OrderService {

    private final MemberRepository memberRepository;
    private final DiscountPolicy discountPolicy;

    @Autowired
    public OrderServiceImpl(MemberRepository memberRepository, DiscountPolicy discountPolicy) {
        this.memberRepository = memberRepository;
        this.discountPolicy = discountPolicy;
    }

    @Override
    public Order createOrder(Long memberId, String itemName, int itemPrice) {
        Member member = memberRepository.findById(memberId);
        int discountPrice = discountPolicy.discount(member, itemPrice);
        return new Order(memberId, itemName, itemPrice, discountPrice);
    }

    // 테스트 용도
    public MemberRepository getMemberRepository() {
        return memberRepository;
    }

}
```
   
___     
   
이제, 실제로 빈이 등록되었는지 그리고 알맞은 클래스타입을 반환하는지 테스트를해보자   
    
**src.test.hello.core.scan.AutoAppConfigTest.class**
```java
package hello.core.scan;

import hello.core.AutoAppConfig;
import hello.core.member.MemberService;
import org.junit.jupiter.api.Test;
import org.springframework.context.annotation.AnnotationConfigApplicationContext;

import static org.assertj.core.api.Assertions.assertThat;

public class AutoAppConfigTest {

    @Test
    void basicScan() {
        // given
        AnnotationConfigApplicationContext ac = new AnnotationConfigApplicationContext(AutoAppConfig.class);

        // when
        MemberService memberService = ac.getBean(MemberService.class);

        // then
        assertThat(memberService).isInstanceOf(MemberService.class);
    }
}
```
```java
22:26:51.025 [main] DEBUG org.springframework.context.annotation.AnnotationConfigApplicationContext - Refreshing org.springframework.context.annotation.AnnotationConfigApplicationContext@18a70f16
22:26:51.051 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'org.springframework.context.annotation.internalConfigurationAnnotationProcessor'
22:26:51.201 [main] DEBUG org.springframework.context.annotation.ClassPathBeanDefinitionScanner - Identified candidate component class: file [/Users/ujae/IdeaProjects/inflearn/core/out/production/classes/hello/core/discount/RateDiscountPolicy.class]
22:26:51.210 [main] DEBUG org.springframework.context.annotation.ClassPathBeanDefinitionScanner - Identified candidate component class: file [/Users/ujae/IdeaProjects/inflearn/core/out/production/classes/hello/core/member/MemberServiceImpl.class]
22:26:51.212 [main] DEBUG org.springframework.context.annotation.ClassPathBeanDefinitionScanner - Identified candidate component class: file [/Users/ujae/IdeaProjects/inflearn/core/out/production/classes/hello/core/member/MemoryMemberRepository.class]
22:26:51.214 [main] DEBUG org.springframework.context.annotation.ClassPathBeanDefinitionScanner - Identified candidate component class: file [/Users/ujae/IdeaProjects/inflearn/core/out/production/classes/hello/core/order/OrderServiceImpl.class]
22:26:51.384 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'org.springframework.context.event.internalEventListenerProcessor'
22:26:51.387 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'org.springframework.context.event.internalEventListenerFactory'
22:26:51.388 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'org.springframework.context.annotation.internalAutowiredAnnotationProcessor'
22:26:51.390 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'org.springframework.context.annotation.internalCommonAnnotationProcessor'
22:26:51.408 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'autoAppConfig'
22:26:51.416 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'rateDiscountPolicy'
22:26:51.416 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'memberServiceImpl'
22:26:51.449 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'memoryMemberRepository'
22:26:51.451 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Autowiring by type from bean name 'memberServiceImpl' via constructor to bean named 'memoryMemberRepository'
22:26:51.452 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'orderServiceImpl'
22:26:51.454 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Autowiring by type from bean name 'orderServiceImpl' via constructor to bean named 'memoryMemberRepository'
22:26:51.455 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Autowiring by type from bean name 'orderServiceImpl' via constructor to bean named 'rateDiscountPolicy'

Process finished with exit code 0
```  
실행 결과를 보면, `ClassPathBeanDefinitionScanner`라는 문구가 있고             
이로인해 컴포넌트 스캔이 일어났음을 예상할 수 있다.           
그리고 그 밑으로 실제로 빈을 싱글톤 패턴으로 등록했다는 것 또한 알 수 있다.        
    
빈으로 등록한 객체들을 식별하는 이름도 같이 나오는데      
스프링 빈의 기본 이름은 클래스명을 사용하되 맨 앞글자만 소문자를 사용한다.     
      
* 빈 이름 기본 전략: `MemberServiceImpl` 클래스 `memberServiceImpl`   
* 빈 이름 직접 지정: 만약 스프링 빈의 이름을 직접 지정하고 싶으면  
   * `@Component("memberService2")` 이런식으로 이름을 부여하면 된다.   


